<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - Users Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
      background: url('/html/GeneralIMG/StandardBG.png') center/cover no-repeat fixed;
       display: flex;
      justify-content: center;
      align-items: center;
      color: white;
    }

    .logo {
      position: absolute;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
    }

    .logo img {
      width: 170px;
    }

    .logout-link {
      position: absolute;
      top: 70px;
      right: 109px;
      font-size: 20px;
      font-weight: bold;
      color: white;
      text-decoration: none;
    }

    .user-profile-bar {
      position: absolute;
      top: 130px;
      left: 0;
      width: 96.1%;
      height: 60px;
      background: #05321d;
      display: flex;
      align-items: center;
      padding-left: 65px;
      font-size: 30px;
    }

      .button-section {
            position: absolute;
            top: 210px;
            left: 20px;
            background: #478159;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            height: calc(100% - 300px);
            width: 300px;
        }

        .button-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 100%;
        }

        .button-container button {
            background: rgba(0, 54, 0, 0.8);
            color: white;
            border: none;
            padding: 15px 20px;
            font-size: 20px;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.3s ease;
        }

        .button-container button:hover {
            background: rgba(115, 227, 107, 0.8);
        }


    .main-content {
     position: absolute;
            top: 210px;
            right: 20px;
            padding: 20px;
            border-radius: 10px;
            height: calc(100% - 300px);
            width: calc(100% - 500px);
            overflow-x: auto;
      background: rgba(0, 0, 0, 0.7);
    
    }

    table {
      width: 100%;
      border-collapse: collapse;
      color: white;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #555;
      text-align: left;
    }

    th {
      background-color: #006937;
    }

    select {
      padding: 5px;
      font-size: 16px;
      margin-top: 10px;
    }
       .rule-item {
      list-style: none;
      position: relative;
      padding-left: 1.75em;
      font-size: 0.9em;
      color: #555;
      text-align: left;
      line-height: 1.4;
    }

    .rule-item::before {
      content: "❌";
      position: absolute;
      left: 0;
      top: 0.05em;
      color: red;
    }

    .rule-item.valid {
      color: #006937;
    }

    .rule-item.valid::before {
      content: "✅";
      color: #006937;
    }

    .error {
      color: red;
      font-size: 0.9em;
      margin-top: 0.25em;
      display: none;
    }

    .close-btn {
      position: absolute;
      right: 20px;
      top: 10px;
      font-size: 20px;
      font-weight: bold;
      color: red;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="logo">
    <img src="/html/IndexIMG/Logo.png" alt="LabSpot Logo">
  </div>

  <a href="/logout" class="logout-link">Logout</a>
  <div class="user-profile-bar">Admin - Users Dashboard</div>

  <div class="button-section">
    <div class="button-container" style="width: 280px;">
            <button onclick="window.location.href='/admin'">Book Seat</button>
            <button onclick="document.getElementById('changePasswordDialog').showModal()">Change Password</button>
            <button onclick="window.location.href='/admin/users'">Users Dashboard</button>
            <button onclick="window.location.href='/admin/logs'">Activity Logs</button>
    </div>
  </div>

  <div class="main-content">
    <h2>Filter Users by Type:</h2>
    <select id="filter" onchange="filterUsers()">
      <option value="all">All</option>
      <option value="technician">Technicians</option>
      <option value="student">Students</option>
       <option value="admin">Admins</option>
    </select>

    <table style="margin-top: 20px;">
  <thead>
    <tr>
      <th>Name</th>
      <th>Email</th>
      <th>User Type</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {{#each users}}
      <tr class="user-row" data-type="{{#if isAdmin}}admin{{else}}{{#if isTechnician}}technician{{else}}student{{/if}}{{/if}}">
        <td>{{name}}</td>
        <td>{{username}}</td>
        <td>
          {{#if isAdmin}}Admin
          {{else if isTechnician}}Technician
          {{else}}Student
          {{/if}}
        </td>
        <td>
          {{#if isTechnician}}
            {{#unless isAdmin}}
              <button onclick="confirmPromotion('{{_id}}', '{{name}}')">Promote to Admin</button>
            {{/unless}}
          {{/if}}
        </td>
      </tr>
    {{/each}}
  </tbody>
</table>
  </div>

  <dialog id="changePasswordDialog" style="text-align: center;">
    <span class="close-btn" onclick="changePasswordDialog.close()">×</span>
    <h3>Change Password</h3>
    <p>Current Password:</p>
    <input type="password" id="currentPass" placeholder="Current Password" />
   

    <p>New Password:</p>
    <input type="password" id="newPass" placeholder="New Password" />
    <ul id="pass-rules">
      <li id="pass-rule-length" class="rule-item">At least 8 characters</li>
      <li id="pass-rule-uppercase" class="rule-item">At least one uppercase letter</li>
      <li id="pass-rule-lowercase" class="rule-item">At least one lowercase letter</li>
      <li id="pass-rule-number" class="rule-item">At least one number (0–9)</li>
      <li id="pass-rule-special" class="rule-item">At least one special character (!@#$%^&*)</li>
    </ul>

    <input type="password" id="confirmNewPass" placeholder="Confirm New Password" />
     <div id="passwordChangeError" class="error" style="display: none;"></div>
    <div id="passMatchError" class="error">Passwords do not match.</div>

    <button id="updatePasswordBtn" disabled>Update</button>
  </dialog>
    <script>
     document.addEventListener("DOMContentLoaded", () => {
    const currentPass = document.getElementById("currentPass");
    const newPass = document.getElementById("newPass");
    const confirmNewPass = document.getElementById("confirmNewPass");
    const updateBtn = document.getElementById("updatePasswordBtn");
    const errorDiv = document.getElementById("passwordChangeError");

    function checkPasswordValid(pass) {
      return /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*]).{8,}$/.test(pass);
    }

    function updatePassRules(pass) {
      document.getElementById("pass-rule-length").classList.toggle("valid", pass.length >= 8);
      document.getElementById("pass-rule-uppercase").classList.toggle("valid", /[A-Z]/.test(pass));
      document.getElementById("pass-rule-lowercase").classList.toggle("valid", /[a-z]/.test(pass));
      document.getElementById("pass-rule-number").classList.toggle("valid", /\d/.test(pass));
      document.getElementById("pass-rule-special").classList.toggle("valid", /[!@#$%^&*]/.test(pass));
    }

    function validateAllInputs() {
      const pass = newPass.value.trim();
      const confirm = confirmNewPass.value.trim();
      const current = currentPass.value.trim();

      const valid = checkPasswordValid(pass);
      const match = pass === confirm;

      updatePassRules(pass);
      document.getElementById("passMatchError").style.display = !match && confirm.length > 0 ? "block" : "none";

      updateBtn.disabled = !(valid && match && current.length > 0);
    }

    [currentPass, newPass, confirmNewPass].forEach(input => {
      input.addEventListener("input", validateAllInputs);
    });

    updateBtn.addEventListener("click", async () => {
      errorDiv.style.display = "none"; // Hide old error

      const res = await fetch("/change-password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          currentPassword: currentPass.value,
          newPassword: newPass.value
        })
      });

      const data = await res.json();

      if (data.success) {
        alert("Password updated successfully!");
        changePasswordDialog.close();

        // Clear inputs & reset UI state
        currentPass.value = "";
        newPass.value = "";
        confirmNewPass.value = "";
        updateBtn.disabled = true;
        errorDiv.style.display = "none";
        document.getElementById("passMatchError").style.display = "none";
         window.location.href = data.redirect || '/login';
      } else {
        // Show backend error message
        errorDiv.textContent = data.message || "An unexpected error occurred.";
        errorDiv.style.display = "block";
      }
    });
  });

   function filterUsers() {
    const selected = document.getElementById('filter').value;
    document.querySelectorAll('.user-row').forEach(row => {
      const type = row.dataset.type;
      row.style.display = selected === 'all' || type === selected ? '' : 'none';
    });
  }

  function confirmPromotion(userId, userName) {
    if (confirm(`Are you sure you want to promote ${userName} to Admin?`)) {
      fetch('/admin/promote', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ userId })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert(`${userName} has been promoted to Admin.`);
          location.reload(); // Reload the page to reflect the change
        } else {
          alert('Failed to promote user.');
        }
      })
      .catch(err => {
        console.error('Promotion error:', err);
        alert('Server error. Try again later.');
      });
    }
  }
   window.onpageshow = function(event) {
    if (event.persisted || (window.performance && performance.navigation.type === 2)) {
      window.location.reload();
    }
  };
  </script>
</body>
</html>
